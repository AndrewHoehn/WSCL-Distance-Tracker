<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>WSCL Travel Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0f172a;        /* slate-900 */
      --card: #111827;      /* gray-900 */
      --muted: #94a3b8;     /* slate-400 */
      --text: #e5e7eb;      /* gray-200 */
      --accent: #38bdf8;    /* sky-400 */
      --accent2: #22d3ee;   /* cyan-400 */
      --tableOdd: #0b1229;
      --tableEven: #0d1530;
      --border: #1f2937;
    }
    html, body { background: var(--bg); color: var(--text); margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji"; }
    h1, h2, h3 { margin: 0 0 .5rem 0; font-weight: 700; }
    h1 { font-size: 1.5rem; letter-spacing: .2px; }
    h2 { font-size: 1.25rem; color: var(--accent); }
    h3 { font-size: 1.1rem; }
    .container { max-width: 1200px; margin: 0 auto; padding: 1rem; }
    .grid { display: grid; gap: 1rem; }
    .grid-cols-2 { grid-template-columns: 1fr 1fr; }
    .grid-cols-3 { grid-template-columns: 1fr 1fr 1fr; }
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 14px; padding: 1rem; box-shadow: 0 10px 30px rgba(0,0,0,.25); }
    .row { display: flex; gap: .75rem; align-items: center; flex-wrap: wrap; }
    .controls select, .controls button {
      background: #0b1229; color: var(--text); border: 1px solid var(--border);
      padding: .5rem .6rem; border-radius: 10px; font-size: .95rem;
    }
    .controls button { cursor: pointer; }
    .controls button.active { outline: 2px solid var(--accent2); }
    .pill { display: inline-block; padding: .15rem .5rem; border-radius: 999px; background: #0b1229; border: 1px solid var(--border); color: var(--muted); font-size: .8rem; }
    table { width: 100%; border-collapse: collapse; margin-top: .5rem; }
    th, td { padding: .55rem .6rem; text-align: left; }
    thead th { font-weight: 600; color: var(--muted); border-bottom: 1px solid var(--border); }
    tbody tr:nth-child(odd)  { background: var(--tableOdd); }
    tbody tr:nth-child(even) { background: var(--tableEven); }
    tbody td { border-bottom: 1px solid var(--border); }
    .right { text-align: right; }
    .muted { color: var(--muted); }
    .stat { display: grid; gap: .2rem; }
    .stat .label { color: var(--muted); font-size: .85rem; }
    .stat .value { font-size: 1.15rem; }
    .footer { margin-top: .75rem; color: var(--muted); font-size: .85rem; }
    a { color: var(--accent); text-decoration: none; }
    a:hover { text-decoration: underline; }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <h1>Washington Student Cycling League — Travel Dashboard</h1>
      <div class="row controls" style="margin-top:.5rem">
        <div class="row">
          <label class="muted">Season</label>
          <select id="seasonFilter">
            <option value="All">All Seasons</option>
            <option value="Spring">Spring</option>
            <option value="Fall">Fall</option>
          </select>
        </div>
        <div class="row">
          <label class="muted">Year</label>
          <select id="yearFilter"></select>
        </div>
        <div class="row">
          <span class="pill" id="metaCounts">—</span>
        </div>
      </div>
    </div>

    <div class="grid grid-cols-3" style="margin-top:1rem">
      <div class="card">
        <h2>Venues — Total Travel</h2>
        <div class="row" style="margin:.5rem 0 0.25rem 0">
          <button class="unitBtn active" data-unit="miles">Miles</button>
          <button class="unitBtn" data-unit="hours">Hours</button>
        </div>
        <table id="venuesTable">
          <thead>
            <tr><th>Venue</th><th class="right"># Events</th><th class="right">Total</th></tr>
          </thead>
          <tbody></tbody>
        </table>
        <div class="footer">Totals reflect current Season/Year filters.</div>
      </div>

      <div class="card">
        <h2>Team Detail</h2>
        <div class="row" style="margin:.5rem 0">
          <select id="teamSelect"></select>
        </div>
        <div id="teamSummary" class="grid" style="grid-template-columns: 1fr 1fr 1fr; gap:.75rem; margin-bottom:.5rem">
          <!-- Filled dynamically -->
        </div>
        <table id="teamVenues">
          <thead>
            <tr><th>Venue</th><th class="right">RT Miles</th><th class="right">RT Hours</th></tr>
          </thead>
          <tbody></tbody>
        </table>
        <div class="footer">Rows reflect current Season/Year filters.</div>
      </div>

      <div class="card">
        <h2>Events</h2>
        <table id="eventsTable">
          <thead>
            <tr><th>Date</th><th>Season</th><th>Venue</th></tr>
          </thead>
          <tbody></tbody>
        </table>
        <div class="footer">Sorted chronologically; reflects current filters.</div>
      </div>
    </div>

    <div class="card" style="margin-top:1rem">
      <h2>Fun Stats</h2>
      <div id="funStats" class="grid" style="grid-template-columns: repeat(4,1fr); gap:.75rem; margin-top:.5rem"></div>
    </div>
  </div>

  <script>
    let appData = null;
    let currentUnit = 'miles'; // 'miles' or 'hours'

    // ---------- Utilities ----------
    function fmtMiles(v) { return (Number(v) || 0).toLocaleString(undefined, { maximumFractionDigits: 1 }); }
    function fmtHours(v) { return (Number(v) || 0).toLocaleString(undefined, { maximumFractionDigits: 2 }); }
    function fmtUnit(v, unit) { return unit === 'hours' ? `${fmtHours(v)} h` : `${fmtMiles(v)} mi`; }

    function milesHoursFor(teamName, locationKey) {
      const v = appData?.distances?.[teamName]?.venues?.[locationKey];
      return { miles: v?.miles || 0, hours: v?.hours || 0 };
    }

    function prettyVenueLabel(vkey) {
      const map = Object.fromEntries(appData.venues.map(v => [v.location_key, `${v.city} — ${v.venue}`]));
      return map[vkey] ?? vkey;
    }

    function currentEventFilter(e) {
      const s = document.getElementById('seasonFilter').value;
      const y = document.getElementById('yearFilter').value;
      const seasonOK = (s === 'All') || (e.season === s);
      const yearOK = (y === 'All') || (e.year === y);
      return seasonOK && yearOK;
    }

    function compareEventChrono(a, b) {
      // Compare by year, month, day numerically
      const A = [parseInt(a.year), parseInt(a.month), parseInt(a.day)];
      const B = [parseInt(b.year), parseInt(b.month), parseInt(b.day)];
      return A[0]-B[0] || A[1]-B[1] || A[2]-B[2];
    }

    // ---------- Filters ----------
    function populateYearFilter() {
      const sel = document.getElementById('yearFilter');
      const years = [...new Set(appData.events.map(e => e.year))].sort();
      sel.innerHTML = `<option value="All">All Years</option>` + years.map(y => `<option value="${y}">${y}</option>`).join('');
    }

    function populateTeamSelect() {
      const sel = document.getElementById('teamSelect');
      const teams = Object.keys(appData.distances).sort((a,b)=>a.localeCompare(b));
      sel.innerHTML = teams.map(t => `<option>${t}</option>`).join('');
    }

    // ---------- Venues View ----------
    function computeVenueTotalsFiltered(unit = currentUnit) {
      const events = appData.events.filter(currentEventFilter);
      const venueEventCounts = new Map();
      for (const e of events) {
        venueEventCounts.set(e.location_key, (venueEventCounts.get(e.location_key) || 0) + 1);
      }

      const totals = [];
      for (const [vkey, count] of venueEventCounts.entries()) {
        let sum = 0;
        for (const [team, d] of Object.entries(appData.distances)) {
          const entry = d.venues[vkey];
          if (!entry) continue;
          sum += (unit === 'hours' ? entry.hours : entry.miles) * count;
        }
        totals.push({ vkey, count, total: +sum.toFixed(unit === 'hours' ? 2 : 1) });
      }

      totals.sort((a, b) => b.total - a.total);
      return totals.map(t => ({ ...t, label: prettyVenueLabel(t.vkey) }));
    }

    function renderVenuesTable(unit = currentUnit) {
      currentUnit = unit;
      document.querySelectorAll('.unitBtn').forEach(btn => btn.classList.toggle('active', btn.dataset.unit === unit));

      const body = document.querySelector('#venuesTable tbody');
      const data = computeVenueTotalsFiltered(unit);

      body.innerHTML = data.length ? data.map(r => `
        <tr>
          <td>${r.label}</td>
          <td class="right">${r.count}</td>
          <td class="right">${fmtUnit(r.total, unit)}</td>
        </tr>`).join('') : `<tr><td colspan="3" class="muted">No data for current filters</td></tr>`;
    }

    // ---------- Team Detail ----------
    function renderTeamDetail() {
      const team = document.getElementById('teamSelect').value;
      const d = appData.distances[team];

      // Summary (precomputed totals)
      const s = d.season_totals;
      const summary = `
        <div class="stat"><div class="label">Total (All Events)</div><div class="value">${fmtMiles(d.total_miles_events)} mi • ${fmtHours(d.total_hours_events)} h</div></div>
        <div class="stat"><div class="label">Spring</div><div class="value">${fmtMiles(s.Spring.miles)} mi • ${fmtHours(s.Spring.hours)} h</div></div>
        <div class="stat"><div class="label">Fall</div><div class="value">${fmtMiles(s.Fall.miles)} mi • ${fmtHours(s.Fall.hours)} h</div></div>
      `;
      document.getElementById('teamSummary').innerHTML = summary;

      // Venue rows filtered to venues that appear in current event set
      const needed = new Set(appData.events.filter(currentEventFilter).map(e => e.location_key));
      const rows = [];
      for (const [vkey, rt] of Object.entries(d.venues)) {
        if (!needed.has(vkey)) continue;
        rows.push({ label: prettyVenueLabel(vkey), miles: rt.miles, hours: rt.hours });
      }
      rows.sort((a,b)=>b.miles - a.miles);

      const body = document.querySelector('#teamVenues tbody');
      body.innerHTML = rows.length ? rows.map(r => `
        <tr>
          <td>${r.label}</td>
          <td class="right">${fmtMiles(r.miles)}</td>
          <td class="right">${fmtHours(r.hours)}</td>
        </tr>`).join('') : `<tr><td colspan="3" class="muted">No venues for current filters</td></tr>`;
    }

    // ---------- Events ----------
    function renderEventsTable() {
      const body = document.querySelector('#eventsTable tbody');
      const vLabel = Object.fromEntries(appData.venues.map(v => [v.location_key, `${v.city} — ${v.venue}`]));
      const rows = appData.events
        .filter(currentEventFilter)
        .sort(compareEventChrono)
        .map(e => {
          const d = `${e.year}-${String(e.month).padStart(2,'0')}-${String(e.day).padStart(2,'0')}`;
          return `<tr><td>${d}</td><td>${e.season}</td><td>${vLabel[e.location_key] || e.location_key}</td></tr>`;
        });

      body.innerHTML = rows.length ? rows.join('') : `<tr><td colspan="3" class="muted">No events for current filters</td></tr>`;
    }

    // ---------- Fun Stats ----------
    function renderFunStats() {
      // Longest single venue RT (league-wide average doesn’t directly exist; pick top venue/team combo by miles)
      let longest = { team: '', venue: '', miles: 0, hours: 0 };
      for (const [team, d] of Object.entries(appData.distances)) {
        for (const [vkey, rt] of Object.entries(d.venues)) {
          if (rt.miles > longest.miles) longest = { team, venue: prettyVenueLabel(vkey), miles: rt.miles, hours: rt.hours };
        }
      }

      // Team with most & least total miles (precomputed)
      const teams = Object.entries(appData.distances);
      teams.sort((a,b)=>b[1].total_miles_events - a[1].total_miles_events);
      const most = teams[0] ? { name: teams[0][0], miles: teams[0][1].total_miles_events, hours: teams[0][1].total_hours_events } : null;
      const least = teams[teams.length-1] ? { name: teams[teams.length-1][0], miles: teams[teams.length-1][1].total_miles_events, hours: teams[teams.length-1][1].total_hours_events } : null;

      // League average miles per team
      const totalMilesAllTeams = teams.reduce((acc, [,d]) => acc + (d.total_miles_events || 0), 0);
      const avgMiles = teams.length ? totalMilesAllTeams / teams.length : 0;

      const el = document.getElementById('funStats');
      el.innerHTML = `
        <div class="stat"><div class="label">Most Miles (Team)</div><div class="value">${most ? `${most.name} — ${fmtMiles(most.miles)} mi` : '—'}</div></div>
        <div class="stat"><div class="label">Least Miles (Team)</div><div class="value">${least ? `${least.name} — ${fmtMiles(least.miles)} mi` : '—'}</div></div>
        <div class="stat"><div class="label">Longest Single Trip</div><div class="value">${longest.venue ? `${longest.team} → ${longest.venue} — ${fmtMiles(longest.miles)} mi • ${fmtHours(longest.hours)} h` : '—'}</div></div>
        <div class="stat"><div class="label">Avg Miles per Team</div><div class="value">${fmtMiles(avgMiles)} mi</div></div>
      `;
    }

    // ---------- Re-render wiring ----------
    function updateMetaCounts() {
      const filteredEvents = appData.events.filter(currentEventFilter).length;
      const meta = document.getElementById('metaCounts');
      meta.textContent = `${appData.venues.length} venues • ${appData.teams.length} teams • ${filteredEvents} events (filtered)`;
    }

    function reRenderAll() {
      updateMetaCounts();
      renderVenuesTable(currentUnit);
      renderTeamDetail();
      renderEventsTable();
      renderFunStats();
    }

    // ---------- Init ----------
    async function init() {
      const res = await fetch('bike_league_data.json');
      appData = await res.json();

      populateYearFilter();
      populateTeamSelect();

      document.getElementById('seasonFilter').addEventListener('change', reRenderAll);
      document.getElementById('yearFilter').addEventListener('change', reRenderAll);
      document.querySelectorAll('.unitBtn').forEach(btn => {
        btn.addEventListener('click', () => renderVenuesTable(btn.dataset.unit));
      });
      document.getElementById('teamSelect').addEventListener('change', renderTeamDetail);

      reRenderAll();
    }

    init();
  </script>
</body>
</html>
