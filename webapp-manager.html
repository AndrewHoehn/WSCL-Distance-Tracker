<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WSCL Distance Tracker - Road Warriors Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen p-6">
    <div class="max-w-7xl mx-auto">
        <div class="bg-gradient-to-r from-indigo-600 to-purple-600 rounded-lg shadow-2xl p-8 mb-8">
            <h1 class="text-4xl font-bold text-white mb-2">Washington State Bike League</h1>
            <h2 class="text-2xl text-indigo-200">Road Warrior Distance Tracker</h2>
            <p class="text-indigo-100 mt-4">Celebrating the teams that go the extra mile... and then some</p>
        </div>

        <div id="loadingSection" class="bg-gray-800 rounded-lg shadow-xl p-6 mb-8">
            <p class="text-center">Loading data...</p>
        </div>

        <div id="mainContent" class="hidden">
            <div class="grid md:grid-cols-4 gap-6 mb-8">
                <div class="bg-gradient-to-br from-yellow-500 to-orange-500 rounded-lg shadow-xl p-6 text-white">
                    <div class="text-sm font-semibold mb-2">Road Warrior Champion</div>
                    <div class="text-2xl font-bold mb-1" id="topTeam">-</div>
                    <div class="text-3xl font-black" id="topMiles">0</div>
                    <div class="text-xs opacity-90">total miles</div>
                </div>
                <div class="bg-gradient-to-br from-green-500 to-teal-500 rounded-lg shadow-xl p-6 text-white">
                    <div class="text-sm font-semibold mb-2">Home Field Advantage</div>
                    <div class="text-2xl font-bold mb-1" id="bottomTeam">-</div>
                    <div class="text-3xl font-black" id="bottomMiles">0</div>
                    <div class="text-xs opacity-90">total miles (lucky!)</div>
                </div>
                <div class="bg-gradient-to-br from-blue-500 to-indigo-500 rounded-lg shadow-xl p-6 text-white">
                    <div class="text-sm font-semibold mb-2">Longest Single Trek</div>
                    <div class="text-lg font-bold mb-1" id="longestRoute">-</div>
                    <div class="text-3xl font-black" id="longestMiles">0</div>
                    <div class="text-xs opacity-90">miles round trip</div>
                </div>
                <div class="bg-gradient-to-br from-purple-500 to-pink-500 rounded-lg shadow-xl p-6 text-white">
                    <div class="text-sm font-semibold mb-2">Average Per Team</div>
                    <div class="text-3xl font-black" id="avgMiles">0</div>
                    <div class="text-xs opacity-90 mt-1">miles across all races</div>
                </div>
            </div>

            <div class="bg-gray-800 rounded-lg shadow-xl p-6 mb-8">
                <h3 class="text-xl font-semibold mb-4">Filter & View</h3>
                <div class="grid md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">View By</label>
                        <select id="viewMode" class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2">
                            <option value="overall">Overall Leaderboard</option>
                            <option value="season">By Season</option>
                            <option value="race">By Race</option>
                            <option value="team">By Team</option>
                        </select>
                    </div>
                    <div id="seasonFilter" class="hidden">
                        <label class="block text-sm font-medium mb-2">Season</label>
                        <select id="seasonSelect" class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2">
                        </select>
                    </div>
                    <div id="raceFilter" class="hidden">
                        <label class="block text-sm font-medium mb-2">Race Location</label>
                        <select id="raceSelect" class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2">
                        </select>
                    </div>
                    <div id="teamFilter" class="hidden">
                        <label class="block text-sm font-medium mb-2">Team</label>
                        <select id="teamSelect" class="w-full bg-gray-700 border border-gray-600 rounded px-3 py-2">
                        </select>
                    </div>
                </div>
            </div>

            <div id="resultsDisplay"></div>
        </div>
    </div>

    <script>
        let appData = null;

        // Load JSON file on page load
        window.addEventListener('DOMContentLoaded', function() {
            fetch('bike_league_data.json')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Could not load bike_league_data.json');
                    }
                    return response.json();
                })
                .then(data => {
                    appData = data;
                    document.getElementById('loadingSection').classList.add('hidden');
                    document.getElementById('mainContent').classList.remove('hidden');
                    initializeApp();
                })
                .catch(error => {
                    document.getElementById('loadingSection').innerHTML =
                        '<p class="text-center text-red-400">Error: Could not load bike_league_data.json<br>Make sure the file is in the same directory as this HTML file.</p>';
                    console.error('Error loading data:', error);
                });
        });

        function initializeApp() {
            calculateFunStats();
            populateFilters();
            setupEventListeners();
            updateDisplay();
        }

        function calculateFunStats() {
            const sorted = Object.entries(appData.distances)
                .sort((a, b) => b[1].total_miles_events - a[1].total_miles_events);

            document.getElementById('topTeam').textContent = sorted[0][0];
            document.getElementById('topMiles').textContent = sorted[0][1].total_miles_events.toFixed(0);

            document.getElementById('bottomTeam').textContent = sorted[sorted.length - 1][0];
            document.getElementById('bottomMiles').textContent = sorted[sorted.length - 1][1].total_miles_events.toFixed(0);

            let longest = { team: '', venue: '', miles: 0 };
            Object.entries(appData.distances).forEach(([team, data]) => {
                Object.entries(data.venues).forEach(([venue, distData]) => {
                    if (distData.miles > longest.miles) {
                        longest = { team, venue, miles: distData.miles };
                    }
                });
            });
            document.getElementById('longestRoute').textContent = `${longest.team} to ${longest.venue.split(',')[0]}`;
            document.getElementById('longestMiles').textContent = longest.miles.toFixed(0);

            const avg = sorted.reduce((sum, [_, data]) => sum + data.total_miles_events, 0) / sorted.length;
            document.getElementById('avgMiles').textContent = avg.toFixed(0);
        }

        function populateFilters() {
            const seasons = [...new Set(appData.events.map(r => `${r.year} ${r.season}`))].sort();
            const seasonSelect = document.getElementById('seasonSelect');
            seasons.forEach(season => {
                const opt = document.createElement('option');
                opt.value = season;
                opt.textContent = season;
                seasonSelect.appendChild(opt);
            });

            const locations = [...new Set(appData.events.map(r => r.location_key))].sort();
            const raceSelect = document.getElementById('raceSelect');
            locations.forEach(loc => {
                const opt = document.createElement('option');
                opt.value = loc;
                opt.textContent = loc;
                raceSelect.appendChild(opt);
            });

            const teams = Object.keys(appData.distances).sort();
            const teamSelect = document.getElementById('teamSelect');
            teams.forEach(team => {
                const opt = document.createElement('option');
                opt.value = team;
                opt.textContent = team;
                teamSelect.appendChild(opt);
            });
        }

        function setupEventListeners() {
            document.getElementById('viewMode').addEventListener('change', function(e) {
                const mode = e.target.value;
                document.getElementById('seasonFilter').classList.toggle('hidden', mode !== 'season');
                document.getElementById('raceFilter').classList.toggle('hidden', mode !== 'race');
                document.getElementById('teamFilter').classList.toggle('hidden', mode !== 'team');
                updateDisplay();
            });

            document.getElementById('seasonSelect').addEventListener('change', function(e) {
                updateDisplay();
            });

            document.getElementById('raceSelect').addEventListener('change', function(e) {
                updateDisplay();
            });

            document.getElementById('teamSelect').addEventListener('change', function(e) {
                updateDisplay();
            });
        }

        function updateDisplay() {
            const mode = document.getElementById('viewMode').value;
            const display = document.getElementById('resultsDisplay');

            switch(mode) {
                case 'overall':
                    display.innerHTML = renderOverallLeaderboard();
                    break;
                case 'season':
                    display.innerHTML = renderSeasonView();
                    break;
                case 'race':
                    display.innerHTML = renderRaceView();
                    break;
                case 'team':
                    display.innerHTML = renderTeamView();
                    break;
            }
        }

        function renderOverallLeaderboard() {
            const sorted = Object.entries(appData.distances)
                .sort((a, b) => b[1].total_miles_events - a[1].total_miles_events);

            let html = '<div class="bg-gray-800 rounded-lg shadow-xl p-6">';
            html += '<h2 class="text-2xl font-bold mb-6">Overall Distance Leaderboard</h2>';
            html += '<div class="space-y-3">';

            sorted.forEach(([team, data], idx) => {
                const medal = idx === 0 ? '🥇' : idx === 1 ? '🥈' : idx === 2 ? '🥉' : '';
                const bgColor = idx === 0 ? 'from-yellow-600 to-orange-600' :
                               idx === 1 ? 'from-gray-400 to-gray-500' :
                               idx === 2 ? 'from-orange-700 to-orange-800' :
                               'from-gray-700 to-gray-800';

                html += `
                    <div class="bg-gradient-to-r ${bgColor} rounded-lg p-4 flex items-center justify-between">
                        <div class="flex items-center gap-4">
                            <div class="text-3xl w-12 text-center">${medal || (idx + 1)}</div>
                            <div>
                                <div class="font-bold text-lg">${team}</div>
                                <div class="text-sm opacity-80">${appData.metadata.total_events} races</div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-3xl font-black">${data.total_miles_events.toFixed(0)}</div>
                            <div class="text-sm opacity-80">miles</div>
                        </div>
                    </div>
                `;
            });

            html += '</div></div>';
            return html;
        }

        function renderSeasonView() {
            const season = document.getElementById('seasonSelect').value;
            const [year, seasonName] = season.split(' ');

            const seasonRaces = appData.events.filter(r =>
                r.year === year && r.season === seasonName
            );

            const seasonTotals = {};
            Object.entries(appData.distances).forEach(([team, data]) => {
                seasonTotals[team] = data.season_totals[seasonName]?.miles || 0;
            });

            const sorted = Object.entries(seasonTotals)
                .sort((a, b) => b[1] - a[1]);

            let html = '<div class="bg-gray-800 rounded-lg shadow-xl p-6">';
            html += `<h2 class="text-2xl font-bold mb-2">${season} Season</h2>`;
            html += `<p class="text-gray-400 mb-6">${seasonRaces.length} races in this season</p>`;
            html += '<div class="overflow-x-auto">';
            html += '<table class="w-full">';
            html += '<thead><tr class="border-b border-gray-700">';
            html += '<th class="text-left py-3 px-4">Rank</th>';
            html += '<th class="text-left py-3 px-4">Team</th>';
            html += '<th class="text-right py-3 px-4">Total Miles</th>';
            html += '</tr></thead><tbody>';

            sorted.forEach(([team, miles], idx) => {
                const medal = idx === 0 ? '🥇' : idx === 1 ? '🥈' : idx === 2 ? '🥉' : '';
                html += `
                    <tr class="border-b border-gray-700 hover:bg-gray-700">
                        <td class="py-3 px-4">${medal}${idx + 1}</td>
                        <td class="py-3 px-4 font-semibold">${team}</td>
                        <td class="py-3 px-4 text-right font-bold text-indigo-400">${miles.toFixed(1)}</td>
                    </tr>
                `;
            });

            html += '</tbody></table></div></div>';
            return html;
        }

        function renderRaceView() {
            const raceKey = document.getElementById('raceSelect').value;
            const race = appData.events.find(r => r.location_key === raceKey);

            const raceDistances = [];
            Object.entries(appData.distances).forEach(([team, data]) => {
                const miles = data.venues[raceKey]?.miles || 0;
                if (miles > 0) {
                    raceDistances.push({ team, miles });
                }
            });

            raceDistances.sort((a, b) => b.miles - a.miles);

            let html = '<div class="bg-gray-800 rounded-lg shadow-xl p-6">';
            html += `<h2 class="text-2xl font-bold mb-2">${raceKey}</h2>`;
            html += `<p class="text-gray-400 mb-6">${race ? `${race.date}/${race.year}` : ''}</p>`;
            html += '<div class="overflow-x-auto">';
            html += '<table class="w-full">';
            html += '<thead><tr class="border-b border-gray-700">';
            html += '<th class="text-left py-3 px-4">Rank</th>';
            html += '<th class="text-left py-3 px-4">Team</th>';
            html += '<th class="text-right py-3 px-4">Round Trip Distance</th>';
            html += '</tr></thead><tbody>';

            raceDistances.forEach((entry, idx) => {
                const colorClass = idx === 0 ? 'text-red-400' :
                                  idx === raceDistances.length - 1 ? 'text-green-400' : 'text-indigo-400';
                const note = idx === 0 ? ' (furthest!)' :
                            idx === raceDistances.length - 1 ? ' (home turf!)' : '';

                html += `
                    <tr class="border-b border-gray-700 hover:bg-gray-700">
                        <td class="py-3 px-4">${idx + 1}</td>
                        <td class="py-3 px-4 font-semibold">${entry.team}</td>
                        <td class="py-3 px-4 text-right font-bold ${colorClass}">${entry.miles.toFixed(1)} mi${note}</td>
                    </tr>
                `;
            });

            html += '</tbody></table></div></div>';
            return html;
        }

        function renderTeamView() {
            const teamName = document.getElementById('teamSelect').value;
            const teamData = appData.distances[teamName];
            const teamInfo = appData.teams.find(t => t.name === teamName);

            const events = appData.events
                .map(event => {
                    const distance = teamData.venues[event.location_key]?.miles || 0;
                    return { ...event, miles: distance };
                })
                .sort((a, b) => new Date(`${a.month}/${a.day}/${a.year}`) - new Date(`${b.month}/${b.day}/${b.year}`));

            const sortedByMiles = [...events].sort((a,b) => b.miles - a.miles);
            const longestTrip = sortedByMiles[0];
            const shortestTrip = sortedByMiles[sortedByMiles.length-1];


            let html = '<div class="bg-gray-800 rounded-lg shadow-xl p-6">';
            html += `<h2 class="text-2xl font-bold mb-2">${teamName}</h2>`;
            html += `<p class="text-gray-400 mb-6">${teamInfo ? `${teamInfo.city}, ${teamInfo.state}` : ''}</p>`;

            html += '<div class="grid md:grid-cols-3 gap-4 mb-6">';
            html += `<div class="bg-gray-700 rounded p-4">
                        <div class="text-sm text-gray-400">Total Distance</div>
                        <div class="text-2xl font-bold text-indigo-400">${teamData.total_miles_events.toFixed(1)} mi</div>
                     </div>`;
            html += `<div class="bg-gray-700 rounded p-4">
                        <div class="text-sm text-gray-400">Longest Trip</div>
                        <div class="text-2xl font-bold text-red-400">${longestTrip.miles.toFixed(1)} mi</div>
                     </div>`;
            html += `<div class="bg-gray-700 rounded p-4">
                        <div class="text-sm text-gray-400">Shortest Trip</div>
                        <div class="text-2xl font-bold text-green-400">${shortestTrip.miles.toFixed(1)} mi</div>
                     </div>`;
            html += '</div>';

            html += '<div class="overflow-x-auto">';
            html += '<table class="w-full">';
            html += '<thead><tr class="border-b border-gray-700">';
            html += '<th class="text-left py-3 px-4">Date</th>';
            html += '<th class="text-left py-3 px-4">Location</th>';
            html += '<th class="text-left py-3 px-4">Season</th>';
            html += '<th class="text-right py-3 px-4">Distance</th>';
            html += '</tr></thead><tbody>';

            events.forEach((entry) => {
                html += `
                    <tr class="border-b border-gray-700 hover:bg-gray-700">
                        <td class="py-3 px-4">${entry.date || '-'}</td>
                        <td class="py-3 px-4 font-semibold">${entry.location_key}</td>
                        <td class="py-3 px-4">${entry.year} ${entry.season}</td>
                        <td class="py-3 px-4 text-right font-bold text-indigo-400">${entry.miles.toFixed(1)} mi</td>
                    </tr>
                `;
            });

            html += '</tbody></table></div></div>';
            return html;
        }
    </script>
</body>
</html>
