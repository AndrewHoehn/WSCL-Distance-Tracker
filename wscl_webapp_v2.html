<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>WSCL Distance Tracker v2 - Enhanced with Attendance Data</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    </head>
    <body class="bg-gray-900 text-gray-100 min-h-screen p-6">
        <div class="max-w-7xl mx-auto">
            <!-- Header -->
            <div class="bg-gradient-to-r from-indigo-600 to-purple-600 rounded-lg shadow-2xl p-8 mb-8">
                <h1 class="text-4xl font-bold text-white mb-2">
                    Washington State Student Cycling League
                </h1>
                <h2 class="text-2xl text-indigo-200">
                    Race Travel Distance Tracker v2
                </h2>
                <p class="text-indigo-100 mt-4">
                    Enhanced with actual rider attendance data - comparing theoretical vs. actual travel miles.
                    <br />
                    <span class="text-sm opacity-80">Data: 2023-2025 | Vehicle assumption: <span id="ridersPerVehicle">2</span> riders per vehicle</span>
                </p>
            </div>

            <div id="loadingSection" class="bg-gray-800 rounded-lg shadow-xl p-6 mb-8">
                <p class="text-center">Loading enhanced data...</p>
            </div>

            <div id="mainContent" class="hidden">
                <!-- Key Metrics Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-gradient-to-br from-yellow-500 to-orange-500 rounded-lg shadow-xl p-6 text-white">
                        <div class="text-sm font-semibold mb-2">Theoretical vs Actual</div>
                        <div class="text-lg font-bold mb-1">Miles Driven</div>
                        <div class="text-2xl font-black" id="actualMiles">0</div>
                        <div class="text-sm opacity-90">vs <span id="theoreticalMiles">0</span> theoretical</div>
                        <div class="text-xs opacity-75 mt-1">Efficiency: <span id="efficiencyRatio">0%</span></div>
                    </div>

                    <div class="bg-gradient-to-br from-green-500 to-teal-500 rounded-lg shadow-xl p-6 text-white">
                        <div class="text-sm font-semibold mb-2">Total Vehicles</div>
                        <div class="text-3xl font-black" id="totalVehicles">0</div>
                        <div class="text-xs opacity-90 mt-1">trips to races</div>
                    </div>

                    <div class="bg-gradient-to-br from-red-500 to-pink-500 rounded-lg shadow-xl p-6 text-white">
                        <div class="text-sm font-semibold mb-2">Travel Cost</div>
                        <div class="text-3xl font-black" id="totalCost">$0</div>
                        <div class="text-xs opacity-90 mt-1">@ $0.70/mile</div>
                    </div>

                    <div class="bg-gradient-to-br from-gray-600 to-gray-700 rounded-lg shadow-xl p-6 text-white">
                        <div class="text-sm font-semibold mb-2">Carbon Impact</div>
                        <div class="text-2xl font-black" id="totalCO2">0</div>
                        <div class="text-xs opacity-90 mt-1">metric tons COâ‚‚</div>
                    </div>
                </div>

                <!-- Controls -->
                <div class="bg-gray-800 rounded-lg shadow-xl p-6 mb-8">
                    <div class="flex flex-wrap items-center gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">View Mode:</label>
                            <select id="viewMode" class="bg-gray-700 text-white rounded px-3 py-2">
                                <option value="actual">Actual Miles (Attendance-Based)</option>
                                <option value="theoretical">Theoretical Miles (1 Team Per Race)</option>
                                <option value="comparison">Side-by-Side Comparison</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-medium mb-2">Season Filter:</label>
                            <select id="seasonFilter" class="bg-gray-700 text-white rounded px-3 py-2">
                                <option value="all">All Seasons</option>
                                <option value="Spring">Spring Only</option>
                                <option value="Fall">Fall Only</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-medium mb-2">Year Filter:</label>
                            <select id="yearFilter" class="bg-gray-700 text-white rounded px-3 py-2">
                                <option value="all">All Years</option>
                                <option value="2023">2023</option>
                                <option value="2024">2024</option>
                                <option value="2025">2025</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Team Rankings -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                    <div class="bg-gray-800 rounded-lg shadow-xl p-6">
                        <h3 class="text-xl font-bold mb-4">Top Road Warriors (Actual Miles)</h3>
                        <div id="topTeamsActual" class="space-y-2">
                            <!-- Populated by JavaScript -->
                        </div>
                    </div>

                    <div class="bg-gray-800 rounded-lg shadow-xl p-6">
                        <h3 class="text-xl font-bold mb-4">Most Efficient Teams</h3>
                        <div class="text-sm text-gray-400 mb-3">
                            (Lowest actual miles relative to theoretical)
                        </div>
                        <div id="mostEfficientTeams" class="space-y-2">
                            <!-- Populated by JavaScript -->
                        </div>
                    </div>
                </div>

                <!-- Charts -->
                <div class="grid grid-cols-1 xl:grid-cols-2 gap-8 mb-8">
                    <!-- Miles per Team Chart -->
                    <div class="bg-gray-800 rounded-lg shadow-xl p-6">
                        <h3 class="text-xl font-bold mb-4">Team Travel Comparison</h3>
                        <div class="relative h-96">
                            <canvas id="teamMilesChart"></canvas>
                        </div>
                    </div>

                    <!-- Season Breakdown Chart -->
                    <div class="bg-gray-800 rounded-lg shadow-xl p-6">
                        <h3 class="text-xl font-bold mb-4">Seasonal Breakdown</h3>
                        <div class="relative h-96">
                            <canvas id="seasonChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Individual Race Analysis -->
                <div class="bg-gray-800 rounded-lg shadow-xl p-6 mb-8">
                    <h3 class="text-xl font-bold mb-4">Individual Race Analysis</h3>
                    <div class="mb-4">
                        <select id="raceSelector" class="bg-gray-700 text-white rounded px-3 py-2 w-full max-w-md">
                            <option value="">Select a race to analyze...</option>
                        </select>
                    </div>
                    <div id="raceAnalysis" class="hidden">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <div>
                                <h4 class="font-bold mb-3">Race Details</h4>
                                <div id="raceDetails" class="space-y-2 text-sm">
                                    <!-- Populated by JavaScript -->
                                </div>
                            </div>
                            <div>
                                <h4 class="font-bold mb-3">Team Participation</h4>
                                <div class="relative h-64">
                                    <canvas id="raceTeamsChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Data Table -->
                <div class="bg-gray-800 rounded-lg shadow-xl p-6">
                    <h3 class="text-xl font-bold mb-4">Detailed Team Data</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="border-b border-gray-700">
                                    <th class="text-left p-2">Team</th>
                                    <th class="text-right p-2">Theoretical Miles</th>
                                    <th class="text-right p-2">Actual Miles</th>
                                    <th class="text-right p-2">Efficiency</th>
                                    <th class="text-right p-2">Vehicles Used</th>
                                    <th class="text-right p-2">Events Attended</th>
                                    <th class="text-right p-2">Cost</th>
                                </tr>
                            </thead>
                            <tbody id="teamDataTable">
                                <!-- Populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <script>
            let v2Data = null;
            let charts = {};

            // Load and initialize data
            async function loadData() {
                try {
                    const response = await fetch('bike_league_data_v2.json');
                    v2Data = await response.json();

                    document.getElementById('ridersPerVehicle').textContent =
                        v2Data.v2_metadata?.riders_per_vehicle || 2;

                    updateDashboard();
                    populateSelectors();

                    document.getElementById('loadingSection').classList.add('hidden');
                    document.getElementById('mainContent').classList.remove('hidden');
                } catch (error) {
                    console.error('Error loading data:', error);
                    document.getElementById('loadingSection').innerHTML =
                        '<p class="text-center text-red-400">Error loading data. Please ensure bike_league_data_v2.json exists.</p>';
                }
            }

            function updateDashboard() {
                updateKeyMetrics();
                updateTeamRankings();
                updateCharts();
                updateDataTable();
            }

            function updateKeyMetrics() {
                const actual = v2Data.actual_metrics;
                const theoretical = v2Data.distances;

                let totalActualMiles = 0;
                let totalTheoreticalMiles = 0;
                let totalVehicles = 0;
                let totalCost = 0;
                let totalCO2 = 0;

                Object.values(actual).forEach(team => {
                    totalActualMiles += team.total_actual_miles || 0;
                    totalVehicles += team.total_vehicles || 0;
                    totalCost += team.total_cost || 0;
                    totalCO2 += team.total_co2_pounds || 0;
                });

                Object.values(theoretical).forEach(team => {
                    totalTheoreticalMiles += team.total_miles_events || 0;
                });

                const efficiency = totalTheoreticalMiles > 0 ?
                    (totalActualMiles / totalTheoreticalMiles * 100) : 0;

                document.getElementById('actualMiles').textContent =
                    Math.round(totalActualMiles).toLocaleString();
                document.getElementById('theoreticalMiles').textContent =
                    Math.round(totalTheoreticalMiles).toLocaleString();
                document.getElementById('efficiencyRatio').textContent =
                    Math.round(efficiency) + '%';
                document.getElementById('totalVehicles').textContent =
                    totalVehicles.toLocaleString();
                document.getElementById('totalCost').textContent =
                    '$' + Math.round(totalCost).toLocaleString();
                document.getElementById('totalCO2').textContent =
                    Math.round(totalCO2 / 2000) + 't';  // Convert pounds to tons
            }

            function updateTeamRankings() {
                const actual = v2Data.actual_metrics;

                // Top teams by actual miles
                const topTeams = Object.entries(actual)
                    .map(([name, data]) => ({
                        name,
                        miles: data.total_actual_miles || 0,
                        events: data.events_attended || 0
                    }))
                    .sort((a, b) => b.miles - a.miles)
                    .slice(0, 10);

                const topTeamsHtml = topTeams.map((team, i) =>
                    `<div class="flex justify-between items-center py-2 ${i < 3 ? 'font-bold' : ''}">
                        <span>${i + 1}. ${team.name}</span>
                        <span>${Math.round(team.miles).toLocaleString()} mi (${team.events} events)</span>
                    </div>`
                ).join('');

                document.getElementById('topTeamsActual').innerHTML = topTeamsHtml;

                // Most efficient teams
                const theoretical = v2Data.distances;
                const efficiencyTeams = Object.entries(actual)
                    .map(([name, data]) => {
                        const theoreticalMiles = theoretical[name]?.total_miles_events || 0;
                        const actualMiles = data.total_actual_miles || 0;
                        const efficiency = theoreticalMiles > 0 ? actualMiles / theoreticalMiles : 0;
                        return {
                            name,
                            efficiency,
                            actualMiles,
                            theoreticalMiles
                        };
                    })
                    .filter(team => team.theoreticalMiles > 0)  // Only teams with theoretical data
                    .sort((a, b) => a.efficiency - b.efficiency)
                    .slice(0, 10);

                const efficiencyHtml = efficiencyTeams.map((team, i) =>
                    `<div class="flex justify-between items-center py-2">
                        <span>${i + 1}. ${team.name}</span>
                        <span>${Math.round(team.efficiency * 100)}% (${Math.round(team.actualMiles)} / ${Math.round(team.theoreticalMiles)})</span>
                    </div>`
                ).join('');

                document.getElementById('mostEfficientTeams').innerHTML = efficiencyHtml;
            }

            function updateCharts() {
                updateTeamMilesChart();
                updateSeasonChart();
            }

            function updateTeamMilesChart() {
                const ctx = document.getElementById('teamMilesChart').getContext('2d');

                if (charts.teamMiles) {
                    charts.teamMiles.destroy();
                }

                const actual = v2Data.actual_metrics;
                const theoretical = v2Data.distances;

                const teams = Object.keys(actual)
                    .filter(name => (actual[name].total_actual_miles || 0) > 0)
                    .sort((a, b) => (actual[b].total_actual_miles || 0) - (actual[a].total_actual_miles || 0))
                    .slice(0, 15);  // Top 15 teams

                const actualData = teams.map(name => actual[name].total_actual_miles || 0);
                const theoreticalData = teams.map(name => theoretical[name]?.total_miles_events || 0);

                charts.teamMiles = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: teams,
                        datasets: [
                            {
                                label: 'Actual Miles',
                                data: actualData,
                                backgroundColor: 'rgba(59, 130, 246, 0.8)',
                                borderColor: 'rgba(59, 130, 246, 1)',
                                borderWidth: 1
                            },
                            {
                                label: 'Theoretical Miles',
                                data: theoreticalData,
                                backgroundColor: 'rgba(156, 163, 175, 0.5)',
                                borderColor: 'rgba(156, 163, 175, 1)',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                labels: { color: 'white' }
                            }
                        },
                        scales: {
                            x: {
                                ticks: {
                                    color: 'white',
                                    maxRotation: 45,
                                    font: { size: 10 }
                                },
                                grid: { color: 'rgba(255,255,255,0.1)' }
                            },
                            y: {
                                ticks: { color: 'white' },
                                grid: { color: 'rgba(255,255,255,0.1)' }
                            }
                        }
                    }
                });
            }

            function updateSeasonChart() {
                const ctx = document.getElementById('seasonChart').getContext('2d');

                if (charts.season) {
                    charts.season.destroy();
                }

                const actual = v2Data.actual_metrics;
                let springMiles = 0, fallMiles = 0;
                let springVehicles = 0, fallVehicles = 0;

                Object.values(actual).forEach(team => {
                    if (team.season_totals) {
                        springMiles += team.season_totals.Spring?.miles || 0;
                        fallMiles += team.
